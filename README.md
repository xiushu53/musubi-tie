# Reach You - 福祉施設アクセシビリティ可視化・検索

Reach Youは、特定の福祉施設へのアクセシビリティを地図上で多角的に可視化し、ユーザーの現在地から高速に施設を検索するためのWebアプリケーションです。

## 都知事杯オープンデータハッカソン2025 提出作品
### 使用データ
- 社会福祉施設等一覧（平成30年5月1日時点） [https://catalog.data.metro.tokyo.lg.jp/dataset/t000054d0000000073](https://catalog.data.metro.tokyo.lg.jp/dataset/t000054d0000000073)
  - 一覧
  - 放課後等デイサービス事業所
  - 障害児相談支援事業所
  - 計画相談事業所
  - 就労継続支援（Ａ型）事業所
  - 就労継続支援（Ｂ型）事業所

### アプリ使用データの生成
- アプリで使用するためGoogle Colabolatoryでデータ処理を実施 `/public/{施設タイプ}`に格納
  - [障害者施設アクセスマップデータ出力.ipynb](/references/障害者施設アクセスマップデータ出力.ipynb)
- **データの概要**
  - `facilities.json`: 障害福祉施設の所在データなど
  - `mesh.geojson`: 東京都内の最近傍施設への距離を示す250mメッシュデータ
  - `voronoi.geojson`: 各施設の独占的な利用圏(ボロノイ領域)を示すボロノイ境界のポリゴンデータ

## 主な機能

### 1. アクセシビリティの可視化

- **最近傍施設までの距離表示**: 各地点から最も近い施設までの距離を、250mメッシュで色分けして地図上に表示します。
- **ボロノイ図**: 各施設がどのエリアをカバーしているか（テリトリー）を可視化します。
- **施設タイプの切り替え**: 「放課後等デイサービス」や「就労継続支援」など、複数の施設タイプに対応したデータを切り替えて表示できます。
- **レイヤーコントロール**: 市区町村の境界線、メッシュ、ボロノイ図、施設マーカーの表示/非表示を自由に切り替えられます。

### 2. 問い合わせデータの統合分析（新機能）

- **問い合わせパフォーマンスの可視化**: 施設ごとの「返信率」「問い合わせ件数」「平均返信時間」などを地図上でヒートマップ表示し、応答の良い施設や需要の高いエリアを直感的に把握できます。
- **需要の可視化（KDEヒートマップ）**: ユーザーがどこから問い合わせを行っているかを、**カーネル密度推定（KDE）** を用いて集計し、滑らかなヒートマップとして可視化します。これにより、個別の点を越えた広域的な需要の「ホットスポット」を特定できます。メッシュサイズは設定ファイル（`src/_settings/analytics/index.ts`）で変更可能です。
- **供給との重ね合わせ**: 問い合わせヒートマップと**全施設の位置**を重ねて表示することで、「需要は高いが施設が少ない」といった需給ギャップのあるエリアを視覚的に発見できます。
- **多角的な分析モード**: 「距離分析」と「統合分析」のモードを切り替え、目的に応じたデータ表示が可能です。
- **インタラクティブな操作**: 地図上の施設やエリアにマウスオーバーすると、詳細な統計データ（総問い合わせ件数、返信率、平均距離など）をツールチップで確認できます。

### 3. 高性能な施設検索

- **現在地からの範囲検索**: ユーザーの現在地情報を基に、指定した半径内（例: 1km, 5km）にある施設を検索します。
- **Geohash空間インデックス**: 事前に計算されたGeohashインデックスを利用することで、数万件の施設データからでも極めて高速（数ミリ秒）な検索を実現しています。
- **DB連携**: 施設データをSQLiteデータベースで管理し、API経由で動的に取得します。
- **検索手法の比較**: 全件スキャン（Brute-force）と複数のGeohash検索アルゴリズム（Basic, Precise, Grid）の性能を比較・分析できます。
- **アクセシブルなUI**: 検索結果はリストと地図で分かりやすく表示され、キーボード操作やスクリーンリーダーにも配慮しています。

### 4. 一括メール送信機能

- **複数施設への一斉問い合わせ**: 検索してリストアップした複数の施設に対し、共通のメッセージと施設ごとの個別メッセージを付けて一括で問い合わせメールを送信できます。
- **メール送信**: **Resend** を利用して、バックエンドから直接メールを送信します。
- **プライバシー保護**: 問い合わせの際、ユーザーの正確な位置情報は施設に送信されず、「渋谷駅周辺」のように丸められた安全な地名に変換されます。

## ページ構成と各ページの役割

本アプリケーションは、主に以下のページで構成されています。

- **`/` (トップページ)**
  - **役割:** アプリケーションの入り口となるランディングページ。プロジェクトの目的を説明し、主要な機能である「アクセシビリティ可視化」と「施設検索」へのナビゲーションを提供します。

- **`/visualize-map` (アクセシビリティ・問い合わせ分析ページ)**
  - **役割:** 「最近傍施設までの距離」や「施設の勢力圏（ボロノイ図）」といった地域全体のアクセシビリティに加え、**問い合わせデータ（返信率、需要エリアなど）を地図上で統合的に分析・可視化します。** 利用者は、どのエリアで福祉サービスが手厚いか、または手薄であるかを多角的に把握できます。

- **`/search` (施設検索ページ)**
  - **役割:** 利用者の現在地や住所から、条件に合った福祉施設を高速に検索する機能を提供します。検索結果はリストと地図の両方で表示され、気になる施設を問い合わせリストに追加することができます。

- **`/inquiry/compose` (問い合わせページ)**
  - **役割:** 検索ページで選択した複数の施設に対して、一括で問い合わせメッセージを送信するためのフォームページです。利用者の情報と共通メッセージ、および施設ごとの個別メッセージを入力できます。

- **`/inquiry/sent` (問い合わせ完了ページ)**
  - **役割:** メール送信の成否結果をユーザーにフィードバックします。どの施設に正常に送信できたか、失敗したかを確認できます。

## 技術スタック

- **フレームワーク**: [Next.js](https://nextjs.org/) (App Router)
- **言語**: [TypeScript](https://www.typescriptlang.org/)
- **データベース**: [Prisma](https://www.prisma.io/), [SQLite](https://www.sqlite.org/index.html)
- **メール送信**: [Resend](https://resend.com/)
- **地図・可視化**:
  - [deck.gl](https://deck.gl/): 大量の地理空間データを高性能にレンダリング
  - [MapLibre GL JS](https://maplibre.org/): オープンソースのベースマップライブラリ
  - [react-map-gl](https://visgl.github.io/react-map-gl/): React用地図コンポーネント
- **UIコンポーネント**:
  - [shadcn/ui](https://ui.shadcn.com/): スタイリッシュでアクセシブルなコンポーネント群
  - [Tailwind CSS](https://tailwindcss.com/): UIのスタイリング
  - [Lucide React](https://lucide.dev/): アイコン
- **コード品質**:
  - [Biome](https://biomejs.dev/): フォーマット、リント、チェックを統合した高速なツールチェイン
- **パッケージ管理**: [pnpm](https://pnpm.io/)

## セットアップと実行方法

### 1. リポジトリのクローン

```bash
git clone https://github.com/your-username/reach-you.git
cd reach-you
```

### 2. 依存関係のインストール

このプロジェクトでは`pnpm`を使用します。

```bash
pnpm install
```

### 3. 環境変数の設定

プロジェクトルートに `.env` ファイルを作成し、`.env.example` を参考に必要な環境変数を設定します。

```bash
cp .env.example .env
```

`.env` ファイルを開き、以下の変数を設定してください。

- `DATABASE_URL`: データベースの接続URL（デフォルトは `file:./dev.db`）
- `RESEND_API_KEY`: ResendのAPIキー
- `FROM_EMAIL`: メールの送信元アドレス
- `DEV_EMAIL`: 開発環境でのメール送信先アドレス

### 4. データベースのセットアップとデータ移行 (必須)

このアプリケーションは施設データをSQLiteデータベースで管理しています。以下のコマンドでデータベースのセットアップと、JSONファイルからのデータ移行を実行します。

```bash
# 1. Prismaでデータベーススキーマを適用
pnpm prisma migrate dev

# 2. JSON施設データをDBに移行
pnpm tsx scripts/migrate-facilities.ts
```

### 5. Geohashデータの生成 (必須)

アプリケーションの高速検索機能を利用するには、施設データからGeohashインデックスを事前に計算し、静的ファイルを生成する必要があります。

```bash
pnpm generate-geohash
```

4,5のコマンドは`public/data`ディレクトリにJSONファイルを生成します。この処理は、初回起動時および施設データ(`public/*/facilities.json`)に更新があった場合に必要です。

### 6. (任意) ダミー問い合わせデータの生成

問い合わせ分析機能をテストするために、ダミーの問い合わせデータを生成することができます。

```bash
# 100件のダミーデータを生成
pnpm tsx scripts/seed-dummy-inquiries.ts

# 生成したダミーデータをすべて削除
pnpm tsx scripts/seed-dummy-inquiries.ts --delete
```

### 7. 開発サーバーの起動

```bash
pnpm dev
```

[http://localhost:3000](http://localhost:3000) をブラウザで開くと、アプリケーションが表示されます。

## 利用可能なスクリプト

- `pnpm dev`: 開発サーバーを起動します。
- `pnpm build`: プロダクション用にアプリケーションをビルドします。ビルド前に`generate-geohash`が自動的に実行されます。
- `pnpm start`: プロダクションビルドを起動します。
- `pnpm generate-geohash`: 検索用の静的Geohashデータを生成します。
- `pnpm lint`: Biomeでコードの静的解析を実行します。
- `pnpm format`: Biomeでコードをフォーマットします。
- `pnpm check`: Biomeでリント、フォーマット、インポートのチェックをまとめて実行します。
- `pnpm prisma migrate dev`: データベースのマイグレーションを実行します。
- `pnpm tsx scripts/migrate-facilities.ts`: 施設データをデータベースに移行します。
- `pnpm tsx scripts/seed-dummy-inquiries.ts`: 100件のダミー問い合わせデータを生成します。
- `pnpm tsx scripts/seed-dummy-inquiries.ts --delete`: 生成されたダミー問い合わせデータを削除します。


## アーキテクチャ

このプロジェクトは、メンテナンス性と拡張性を高めるために、**機能ベース（フィーチャーベース）のディレクトリ構造**を採用しています。関連するコード（コンポーネント、フック、状態管理など）を機能ごとにまとめることで、関心事の分離を図っています。

- **データフローの変更**: 当初は静的なJSONファイルをクライアントに配信していましたが、現在は**Prisma**を介して**SQLiteデータベース**からデータを取得するアーキテクチャに変更されています。施設データはNext.jsのAPIルート(`src/app/api/facilities`)経由で提供され、クライアントサイドで動的にGeohashインデックスが構築されます。
- **機能ごとの関心事の分離**: `search`（検索）、`inquiry`（問い合わせ）、`map`（地図）のように、主要な機能ごとにディレクトリが分割されています。これにより、特定の機能を修正する際に影響範囲が分かりやすくなります。
- **コンポーネントの粒度**: コンポーネントは、`_components/ui` にあるような再利用可能な最小単位のUI部品（アトム）と、各機能ディレクトリ（例: `_components/search`）にあるような、より大きな責務を持つページやセクションを構成するコンポーネント（オーガニズム）に分けられています。
- **カスタムフックによるロジックの分離**: 複雑なビジネスロジックや、複数のコンポーネントで共有される状態管理ロジックは、カスタムフック（例: `useFacilitySearch`, `useInquiryForm`）に抽出され、`_hooks` ディレクトリに集約されています。
- **外部設定の一元管理**: 可視化の挙動や計算に関するパラメータ（KDEのメッシュサイズやヒートマップの色分けなど）は、`_settings` ディリクトリで一元管理されており、アプリケーション全体の動作を容易に調整できます。

## ディレクトリ構造

プロジェクトの主要なディレクトリとファイルの概要です。

```
.
├── prisma/              # Prismaスキーマとマイグレーションファイル
│   ├── schema.prisma    # データベースモデルの定義
│   └── migrations/      # データベースのマイグレーション履歴
├── public/              # 地図データ、アイコンなどの静的リソース
│   ├── data/            # generate-geohashスクリプトで生成された施設データ
│   ├── {施設タイプ}       # 施設位置データ(DB移行元)、最近傍距離メッシュデータ、ボロノイ境界ポリゴン
│   └── ...
├── references/          # データ処理の参考Jupyter Notebook
├── scripts/             # データ移行やダミーデータ生成などのNode.jsスクリプト
└── src/
    ├── _components/     # Reactコンポーネント
    │   ├── debug/       # デバッグ用コンポーネント
    │   ├── inquiry/     # 問い合わせ機能関連コンポーネント
    │   ├── map/         # 地図表示（deck.gl, MapLibre）関連コンポーネント
    │   ├── search/      # 検索インターフェース関連コンポーネント
    │   └── ui/          # shadcn/uiベースの汎用UIコンポーネント
    ├── _hooks/          # カスタムReactフック。ビジネスロジックやUI状態管理をカプセル化
    ├── _settings/       # 可視化設定などの定数
    │   └── analytics/   # 問い合わせ分析機能の表示・計算に関する設定
    ├── _stores/         # Zustandによるグローバルな状態管理（問い合わせ情報など）
    ├── _utils/          # 距離計算やGeohash処理などの汎用ユーティリティ関数
    ├── app/             # Next.js App Router
    │   ├── api/         # データ取得・メール送信用のAPIエンドポイント
    │   │   ├── analytics/ # 分析データ用API
    │   │   │   ├── inquiries/       # 施設ごとの問い合わせ統計API
    │   │   │   └── inquiry-origins/ # 問い合わせ発信地点の密度（KDE）計算API
    │   │   ├── facilities/ # 施設データ用API
    │   │   └── inquiry/   # 問い合わせメール送信用API
    │   └── ...          # 各ページのUIとルーティング
    ├── lib/             # Prismaクライアントのインスタンス化など
    └── types/           # TypeScriptの型定義
```